{% extends "blog/blog_base.html" %}
{% load static %}

{% block head %}
<title>Chat Realtime</title>
<style>
    #chat-container {
        width: 100%;
        max-width: 600px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
        padding: 15px;
        color: white;
        margin: 100px auto;
    }

    #chat-log {
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 10px;
        overflow-y: auto;
        margin-bottom: 10px;
        scroll-behavior: smooth;
    }

    #chat-message-input {
        width: 75%;
        border: none;
        border-radius: 5px;
        padding: 8px;
        outline: none;
    }

    #chat-message-submit {
        width: 20%;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px;
        font-weight: bold;
    }

    #chat-message-submit:hover {
        background-color: #218838;
        cursor: pointer;
    }

    .message-user {
        text-align: right;
        color: #aef1a8;
        margin: 4px 0;
    }

    .message-other {
        text-align: left;
        color: #ffb6b6;
        margin: 4px 0;
    }

    .system-message {
        text-align: center;
        font-style: italic;
        color: #b0b0b0;
        margin: 4px 0;
    }

    .time {
    font-size: 0.8em;
    color: #b0b0b0;
    margin-left: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div id="chat-container">
    <h3 class="text-center">üí¨ Chat Realtime</h3>
    {% if error_message %}
    <p class="text-red-500">{{ error_message }}</p>
    {% endif %} 
    <div id="chat-log">
        {% if chat_messages %}
            {% for msg in chat_messages %}
                {% if msg.author.author_name == current_author_name %}
                    <div class="message-user">
                        <b>B·∫°n:</b> {{ msg.context }}
                        <span class="time">({{ msg.date|date:"H:i" }})</span>
                    </div>
                {% else %}
                    <div class="message-other">
                        <b>{{ msg.author.author_name }}:</b> {{ msg.context }}
                        <span class="time">({{ msg.date|date:"H:i" }})</span>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="system-message">üí¨ B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi</div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between">
        <input id="chat-message-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button id="chat-message-submit">G·ª≠i</button>
    </div>
</div>

<script>
    // ====== 1Ô∏è‚É£ C√°c h√†m ti·ªán √≠ch ======
    const chatLog = document.getElementById('chat-log');
    const inputField = document.getElementById('chat-message-input');
    const sendBtn = document.getElementById('chat-message-submit');

    // Escape HTML ƒë·ªÉ tr√°nh XSS (b·∫£o m·∫≠t)
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, tag => (
            {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[tag] || tag
        ));
    }

    // Hi·ªÉn th·ªã tin nh·∫Øn
    function addUserMessage(message) {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        chatLog.innerHTML += `<div class="message-user"><b>B·∫°n:</b> ${escapeHTML(message)} <span class="time">(${time})</span></div>`;
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addOtherMessage(author, message) {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        chatLog.innerHTML += `<div class="message-other"><b>${escapeHTML(author)}:</b> ${escapeHTML(message)} <span class="time">(${time})</span></div>`;
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addSystemMessage(message) {
        chatLog.innerHTML += `<div class="system-message">${escapeHTML(message)}</div>`;
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ====== 2Ô∏è‚É£ Thi·∫øt l·∫≠p k·∫øt n·ªëi WebSocket ======
    const currentAuthorname = "{{ current_author_name }}";
    const roomId = "{{ room_id }}"; 
    const wsUrl = `ws://${window.location.host}/ws/chat/${roomId}/`; 
    console.log("üîó WebSocket URL:", wsUrl);

    if (!roomId || roomId === 'None') {
        addSystemMessage('‚ö†Ô∏è L·ªói: Kh√¥ng t√¨m th·∫•y ID ph√≤ng h·ª£p l·ªá. Kh√¥ng th·ªÉ k·∫øt n·ªëi chat.');
    } else {
        let chatSocket = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            chatSocket = new WebSocket(wsUrl);

            chatSocket.onopen = function() {
                clearTimeout(reconnectTimer);
                addSystemMessage('‚úÖ ƒê√£ k·∫øt n·ªëi ƒë·∫øn server');
                inputField.disabled = false;
                sendBtn.disabled = false;
                inputField.focus();
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);

                if (data.source === "room_broadcast") {
                    if (data.author_name === currentAuthorname) {
                        addUserMessage(data.message);
                    } else {
                        addOtherMessage(data.author_name, data.message);
                    }
                } else {
                    addSystemMessage(data.message);
                }
            };

            chatSocket.onclose = function() {
                addSystemMessage('‚ùå M·∫•t k·∫øt n·ªëi WebSocket. Th·ª≠ k·∫øt n·ªëi l·∫°i sau 3 gi√¢y...');
                inputField.disabled = true;
                sendBtn.disabled = true;

                // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i sau 3 gi√¢y
                reconnectTimer = setTimeout(connectWebSocket, 3000);
            };

            chatSocket.onerror = function() {
                addSystemMessage('‚ö†Ô∏è L·ªói khi k·∫øt n·ªëi ƒë·∫øn server.');
                chatSocket.close();
            };
        }

        connectWebSocket();

        // ====== 3Ô∏è‚É£ X·ª≠ l√Ω g·ª≠i tin nh·∫Øn ======
        function sendMessage() {
            const message = inputField.value.trim();
            if (!message) return;

            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'author_name': currentAuthorname
                }));
                inputField.value = '';
                inputField.focus();

                // Ch·ªëng spam g·ª≠i qu√° nhanh
                sendBtn.disabled = true;
                setTimeout(() => sendBtn.disabled = false, 200);
            } else {
                addSystemMessage('‚ö†Ô∏è K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng. H√£y ƒë·ª£i server k·∫øt n·ªëi l·∫°i.');
            }
        }

        sendBtn.onclick = sendMessage;
        inputField.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Focus t·ª± ƒë·ªông khi t·∫£i trang
        window.onload = () => inputField.focus();
    }
</script>

{% endblock %}